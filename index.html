<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ลงทะเบียน PDPA</title>
    <script src="https://static.line-scdn.net/liff/sdk/v2/liff.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: auto;
        }
        h2 {
            color: #008cba;
            text-align: center;
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input[type="text"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #008cba;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background-color: #007bb5;
        }
        #userInfo, #pdpaContentSection, #statusMessage {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background-color: #f9f9f9;
        }
        #pdpaContent {
            max-height: 250px; /* กำหนดความสูงสูงสุด */
            overflow-y: auto; /* ทำให้เลื่อนได้ */
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #fff;
            white-space: pre-wrap; /* รักษารูปแบบบรรทัด */
        }
        .checkbox-container {
            margin-top: 20px;
            display: flex;
            align-items: center;
        }
        .checkbox-container input[type="checkbox"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
        }
        .message {
            padding: 10px;
            margin-top: 15px;
            border-radius: 4px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
        #loadingSpinner {
            display: none; /* ซ่อนไว้ตอนแรก */
            text-align: center;
            margin-top: 20px;
        }
        #loadingSpinner::after {
            content: '';
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top-color: #008cba;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ลงทะเบียน PDPA</h2>

        <div id="statusMessage" class="message info" style="display:none;"></div>
        <div id="loadingSpinner"></div>

        <label for="citizenId">เลขบัตรประชาชน:</label>
        <input type="text" id="citizenId" placeholder="กรอกเลขบัตรประชาชน 13 หลัก" maxlength="13">
        <button id="checkDataBtn">ตรวจสอบข้อมูล</button>

        <div id="userInfo" style="display:none;">
            <p><strong>ยศ:</strong> <span id="userRank"></span></p>
            <p><strong>ชื่อ:</strong> <span id="userName"></span></p>
            <p><strong>สกุล:</strong> <span id="userLastName"></span></p>
        </div>

        <div id="pdpaContentSection" style="display:none;">
            <h3>ข้อกำหนดและเงื่อนไข PDPA</h3>
            <div id="pdpaContent">
                Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.

                <br><br>

                **[ตัวอย่างเนื้อหา PDPA ยาวๆ]**
                * การเก็บรวบรวมข้อมูล: เราเก็บรวบรวมข้อมูลส่วนบุคคลของคุณ เช่น ชื่อ, ที่อยู่, เบอร์โทรศัพท์, อีเมล, และข้อมูลบัตรประชาชน เพื่อวัตถุประสงค์ในการระบุตัวตน, การติดต่อสื่อสาร, และการให้บริการตามที่คุณร้องขอ.
                * วัตถุประสงค์ในการใช้ข้อมูล: ข้อมูลของคุณจะถูกนำไปใช้เพื่อการลงทะเบียน, การยืนยันตัวตน, การนำเสนอข้อมูลข่าวสารที่เกี่ยวข้อง, และการปฏิบัติตามกฎหมายที่เกี่ยวข้อง. เราจะไม่นำข้อมูลของคุณไปใช้เพื่อวัตถุประสงค์อื่นใดโดยไม่ได้รับความยินยอมจากคุณ.
                * การเปิดเผยข้อมูล: เราอาจเปิดเผยข้อมูลของคุณให้กับหน่วยงานราชการ, ผู้ให้บริการภายนอก, หรือบุคคลที่สามที่เกี่ยวข้องกับการดำเนินงานของเรา โดยจะดำเนินการภายใต้ข้อกำหนดของกฎหมายและข้อตกลงในการปกป้องข้อมูลส่วนบุคคล.
                * สิทธิของเจ้าของข้อมูล: คุณมีสิทธิในการเข้าถึง, แก้ไข, ลบ, หรือระงับการใช้ข้อมูลส่วนบุคคลของคุณ คุณสามารถติดต่อเราเพื่อใช้สิทธิเหล่านี้ได้ตลอดเวลา.
                * มาตรการรักษาความปลอดภัย: เรามีมาตรการรักษาความปลอดภัยที่เหมาะสมเพื่อป้องกันการเข้าถึง, ใช้, เปิดเผย, แก้ไข, หรือทำลายข้อมูลส่วนบุคคลของคุณโดยไม่ได้รับอนุญาต.
                * ระยะเวลาจัดเก็บข้อมูล: เราจะจัดเก็บข้อมูลส่วนบุคคลของคุณตามความจำเป็นเพื่อวัตถุประสงค์ที่ระบุไว้ หรือตามระยะเวลาที่กฎหมายกำหนด.
                * การแก้ไขนโยบาย: เราอาจปรับปรุงหรือแก้ไขนโยบายความเป็นส่วนตัวนี้เป็นครั้งคราว โดยจะแจ้งให้คุณทราบถึงการเปลี่ยนแปลงที่สำคัญ.

                <br><br>

                โปรดอ่านและทำความเข้าใจข้อกำหนดทั้งหมด.
            </div>

            <div class="checkbox-container">
                <input type="checkbox" id="acceptPdpa">
                <label for="acceptPdpa">ยอมรับและเข้าใจการยินยอมต่างๆ</label>
            </div>
            <button id="saveDataBtn">บันทึกข้อมูล</button>
        </div>
    </div>

    <script>
        // LIFF ID ของคุณ (จะได้รับเมื่อสร้าง LIFF App ใน LINE Developers Console)
        const LIFF_ID = '2006679138-AVYxW837'; // <--- **เปลี่ยนเป็น LIFF ID ของคุณ**

        document.addEventListener('DOMContentLoaded', function() {
            liff.init({ liffId: LIFF_ID })
                .then(() => {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        console.log('LIFF initialized and logged in.');
                        // สามารถเรียก getUserProfile() ได้ที่นี่ หากต้องการแสดงข้อมูลโปรไฟล์ LINE ทันที
                    }
                })
                .catch((err) => {
                    console.error('LIFF initialization failed', err);
                    alert('เกิดข้อผิดพลาดในการโหลด LIFF: ' + err.message);
                });

            const citizenIdInput = document.getElementById('citizenId');
            const checkDataBtn = document.getElementById('checkDataBtn');
            const saveDataBtn = document.getElementById('saveDataBtn');
            const userInfoDiv = document.getElementById('userInfo');
            const pdpaContentSection = document.getElementById('pdpaContentSection');
            const userRankSpan = document.getElementById('userRank');
            const userNameSpan = document.getElementById('userName');
            const userLastNameSpan = document.getElementById('userLastName');
            const acceptPdpaCheckbox = document.getElementById('acceptPdpa');
            const statusMessageDiv = document.getElementById('statusMessage');
            const loadingSpinner = document.getElementById('loadingSpinner');

            // --- UI Helper Functions ---
            function showMessage(type, message) {
                statusMessageDiv.className = `message ${type}`;
                statusMessageDiv.textContent = message;
                statusMessageDiv.style.display = 'block';
            }

            function hideMessage() {
                statusMessageDiv.style.display = 'none';
            }

            function showLoading() {
                loadingSpinner.style.display = 'block';
                checkDataBtn.disabled = true;
                saveDataBtn.disabled = true;
            }

            function hideLoading() {
                loadingSpinner.style.display = 'none';
                checkDataBtn.disabled = false;
                saveDataBtn.disabled = false;
            }

            // --- Event Listeners ---
            checkDataBtn.addEventListener('click', async () => {
                hideMessage();
                const citizenId = citizenIdInput.value.trim();

                // ตรวจสอบความถูกต้องของเลขบัตรประชาชน
                if (!/^\d{13}$/.test(citizenId)) {
                    showMessage('error', 'กรุณากรอกเลขบัตรประชาชนให้ครบ 13 หลักที่เป็นตัวเลขเท่านั้น');
                    return;
                }

                showLoading();
                try {
                    const response = await callGoogleAppsScript('checkCitizenId', { citizenId });
                    console.log('Response from Apps Script (checkCitizenId):', response);

                    if (response.success) {
                        userInfoDiv.style.display = 'block';
                        pdpaContentSection.style.display = 'block';

                        userRankSpan.textContent = response.data.rank || '-';
                        userNameSpan.textContent = response.data.name || '-';
                        userLastNameSpan.textContent = response.data.lastName || '-';

                        // ตั้งค่า checkbox ตามสถานะ PDPA ล่าสุด
                        acceptPdpaCheckbox.checked = response.data.pdpaStatus === 1;

                        if (response.data.hasRecord) {
                            showMessage('info', `พบข้อมูลของคุณ: ${response.data.rank} ${response.data.name} ${response.data.lastName}. สถานะ PDPA ล่าสุด: ${response.data.pdpaStatus === 1 ? 'ยอมรับ' : 'ไม่ยอมรับ'}.`);
                        } else {
                            showMessage('info', `ไม่พบข้อมูลสำหรับเลขบัตรประชาชนนี้ กรุณาตรวจสอบ หรือดำเนินการบันทึก.`);
                        }

                    } else {
                        showMessage('error', response.message || 'เกิดข้อผิดพลาดในการตรวจสอบข้อมูล');
                        userInfoDiv.style.display = 'none';
                        pdpaContentSection.style.display = 'none';
                        acceptPdpaCheckbox.checked = false; // รีเซ็ต checkbox
                    }
                } catch (error) {
                    console.error('Error checking citizen ID:', error);
                    showMessage('error', 'เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาลองใหม่อีกครั้ง');
                } finally {
                    hideLoading();
                }
            });

            saveDataBtn.addEventListener('click', async () => {
                hideMessage();
                const citizenId = citizenIdInput.value.trim();

                if (!/^\d{13}$/.test(citizenId)) {
                    showMessage('error', 'กรุณากรอกเลขบัตรประชาชนให้ครบ 13 หลักที่เป็นตัวเลขเท่านั้น');
                    return;
                }

                // ตรวจสอบว่าได้ข้อมูลผู้ใช้แล้วก่อนบันทึก
                if (userInfoDiv.style.display === 'none' && !confirm("คุณยังไม่ได้ตรวจสอบข้อมูลเลขบัตรประชาชน หากบันทึกตอนนี้อาจไม่มีข้อมูลชื่อ-สกุล ต้องการบันทึกหรือไม่?")) {
                     return;
                }

                showLoading();
                try {
                    const profile = await liff.getProfile();
                    const userId = profile.userId;
                    const displayName = profile.displayName;
                    const pictureUrl = profile.pictureUrl; // หากต้องการเก็บรูปโปรไฟล์ด้วย

                    const pdpaStatus = acceptPdpaCheckbox.checked ? 1 : 0;

                    const dataToSave = {
                        citizenId: citizenId,
                        pdpaStatus: pdpaStatus,
                        lineUserId: userId,
                        lineDisplayName: displayName,
                        // linePictureUrl: pictureUrl, // เพิ่มหากต้องการ
                    };

                    const response = await callGoogleAppsScript('savePdpaData', dataToSave);
                    console.log('Response from Apps Script (savePdpaData):', response);

                    if (response.success) {
                        showMessage('success', 'บันทึกข้อมูล PDPA สำเร็จ!');
                        // อาจจะปิด LIFF หรือแสดงหน้าจอสรุป
                        // liff.closeWindow();
                    } else {
                        showMessage('error', response.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
                    }
                } catch (error) {
                    console.error('Error saving data:', error);
                    showMessage('error', 'เกิดข้อผิดพลาดในการบันทึกข้อมูล กรุณาลองใหม่อีกครั้ง');
                } finally {
                    hideLoading();
                }
            });

            // --- Function to call Google Apps Script ---
            async function callGoogleAppsScript(functionName, data) {
                // URL ของ Web App ที่ deploy จาก Google Apps Script
                // <--- **เปลี่ยนเป็น URL Web App ของคุณ**
                const webAppUrl = 'https://script.google.com/macros/s/AKfycbzrwH6UYUH2RRdpGzWhR2qdiMojZq8jcW62pBEHzij0eVeVqlpylIYwwLtfXCdUryep/exec';

                const url = new URL(webAppUrl);
                url.searchParams.append('action', functionName);
                url.searchParams.append('data', JSON.stringify(data));

                const response = await fetch(url.toString(), {
                    method: 'GET', // หรือ 'POST' หากต้องการส่งข้อมูลแบบ body
                    // headers: { 'Content-Type': 'application/json' }, // หากใช้ POST และส่ง JSON body
                    // body: JSON.stringify(data) // หากใช้ POST และส่ง JSON body
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            }
        });
    </script>
</body>
</html>
